<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' http://localhost:3052"
    />
    <title>Login - WebSec</title>
    <link rel="stylesheet" href="../assets/css/styles.css" />
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <h1>Welcome Back</h1>
          <p>Login to your account</p>
        </div>

        <div id="messageContainer"></div>

        <form id="loginForm" class="auth-form" novalidate>
          <div class="form-group">
            <label for="username">
              Username or Email <span class="required">*</span>
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              placeholder="Enter your username or email"
              autocomplete="username"
              maxlength="100"
            />
          </div>

          <div class="form-group">
            <label for="password">
              Password <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <input
                type="password"
                id="password"
                name="password"
                required
                placeholder="Enter your password"
                autocomplete="current-password"
                maxlength="128"
              />
              <button
                type="button"
                class="toggle-password"
                aria-label="Toggle password visibility"
                onclick="togglePasswordVisibility('password')"
              >
                üëÅÔ∏è
              </button>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-block">
            Login
          </button>
        </form>

        <div class="auth-footer">
          <p>Don't have an account? <a href="signup.html">Sign Up</a></p>
          <p><a href="../index.html">Back to Home</a></p>
        </div>
      </div>
    </div>

    <div id="loadingSpinner" class="loading-spinner" style="display: none">
      <div class="spinner"></div>
    </div>

    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/validation.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      // Redirect if already authenticated
      Auth.redirectIfAuthenticated();

      // Initialize CSRF token
      SecurityUtils.storeCSRFToken();

      // Toggle password visibility
      function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        if (field.type === 'password') {
          field.type = 'text';
          button.textContent = 'üôà';
        } else {
          field.type = 'password';
          button.textContent = 'üëÅÔ∏è';
        }
      }

      // Add live validation
      const usernameField = document.getElementById('username');
      const passwordField = document.getElementById('password');

      validator.addLiveValidation(usernameField, [
        { type: 'required' },
        { type: 'minLength', length: 3 },
      ]);

      validator.addLiveValidation(passwordField, [
        { type: 'required' },
        { type: 'minLength', length: 6 },
      ]);

      // Handle login form submission
      document
        .getElementById('loginForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault();

          const username = document.getElementById('username').value.trim();
          const password = document.getElementById('password').value;

          // Client-side validation
          if (!username || !password) {
            showError('Please fill in all fields');
            return;
          }

          if (username.length < 3) {
            showError('Username must be at least 3 characters');
            return;
          }

          if (password.length < 6) {
            showError('Password must be at least 6 characters');
            return;
          }

          // Check for suspicious input
          const suspiciousCheck = SecurityUtils.detectSuspiciousInput(username);
          if (suspiciousCheck.suspicious) {
            showError('Invalid input detected');
            return;
          }

          // Sanitize input
          const sanitizedUsername = validator.sanitizeInput(username);

          try {
            showLoading();
            const response = await api.login(sanitizedUsername, password);

            // Save authentication data
            const roles = response.body?.roles || ['CUSTOMER'];
            Auth.saveAuth(response.accessToken, response.body, roles);

            showSuccess('Login successful! Redirecting...');

            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 1000);
          } catch (error) {
            hideLoading();
            showError(
              error.message || 'Login failed. Please check your credentials.'
            );
          }
        });

      // Prevent multiple form submissions
      let isSubmitting = false;
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        if (isSubmitting) {
          e.preventDefault();
          return;
        }
        isSubmitting = true;
        setTimeout(() => {
          isSubmitting = false;
        }, 3000);
      });
    </script>
  </body>
</html>
